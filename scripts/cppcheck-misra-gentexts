#!/bin/bash

prog_name=$(basename "${0}")
# this_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Usage
usage() {
    echo "Usage: ${prog_name} [ args ]"
    echo "args (optional):"
    echo "    --filename [ pdf filename ]       : default '${MISRAC_FNAME}'"
    echo ""
    echo "Generate MISRA C 2012 texts file from PDF using xPDF for mac or linux."
    echo "xpdf (including pdftotext tool) and python3 are required to run the script."
    echo "The generated file 'misra-texts.txt' lists rules with the following structure:"
    echo ""
    echo "Rule <topic number>.<rule number>"
    echo "    <category>"
    echo "    <text>"
    echo ""
    echo "Rule <topic number>.<rule number>"
    echo "    <category>"
    echo "    <text>"
    echo ""
    echo "..."
    echo ""
    echo "where <topic number> and <rule number> are integers,"
    echo "<category> is 'Mandatory', 'Required', or 'Advisory',"
    echo "and <text> is the rule description."
    exit 1
}

# defaults
defaults() {

    MISRAC_FNAME=MISRA_C_2012.pdf

    PLAT='unknown'
    unamestr=$(uname)
    if [[ "$unamestr" == 'Darwin' ]]; then
       PLAT=mac
    elif [[ "$unamestr" == 'Linux' ]]; then
       PLAT=linux
    fi

    PYTHON3="$(which python3)"

    PDFTOTEXT="$(which pdftotext)"

}

#Set defaults
defaults

# Parse arguments
while [[ ${#} -ge 1 && ${1::1} == '-' ]]; do
    key="$1"
    case $key in
        '-h' | '--help' ) usage ;;
        '--filename')
            if [[ ${#} -eq 1 ]] ; then
                usage
            else
                MISRAC_FNAME="$2"
            fi
            shift
            ;;
        * )
            usage
            ;;
    esac
    shift
done

# check platform
if [ $PLAT = 'unknown' ] ; then
    echo "ERROR: Unsupported platform (mac or linux not detected)"
  usage
fi

# check python3
if [ "x$PYTHON3" = "xpython3 not found" ] ; then
    echo "ERROR: python3 executable not found. Make sure it's on your PATH"
  usage
fi

# check pdftotext
if [ "x$PDFTOTEXT" = "xpdftotext not found" ] ; then
    echo "ERROR: pdftotext executable not found. Make sure xpdf is installed"
  usage
fi

# filename without extension
MISRAC_FNAME_NOEXT="${MISRAC_FNAME%.*}"

# run
pdftotext -enc UTF-8 -eol unix "${MISRAC_FNAME}"
python3 cppcheck-misra-parsetexts.py "${MISRAC_FNAME_NOEXT}.txt"

# "${this_dir}/cppcheck-misra-parsetexts.py" "${MISRAC_FNAME_NOEXT}.txt"
